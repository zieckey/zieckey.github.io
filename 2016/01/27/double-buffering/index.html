<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.89.4" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>应用双缓冲技术完美解决资源数据优雅无损的热加载问题 &middot; CodeG Blog</title>
  <meta name="description" content="在一个网络服务器不间断运行过程中，有一些资源数据需要实时更新，例如需要及时更新一份白名单列表，怎么做才能做到优雅无损的更新到服务的进程空间内？这里我们提出一种叫“双缓冲”的技术来解决这种问题。" />

  
  <link type="text/css" rel="stylesheet" href="http://zieckey.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="http://zieckey.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="http://zieckey.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="http://zieckey.github.io/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://zieckey.github.io/"><h1>CodeG Blog</h1></a>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="http://zieckey.github.io/">Home</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2021. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>应用双缓冲技术完美解决资源数据优雅无损的热加载问题</h1>
  <time datetime=2016-01-27T00:00:00Z class="post-date">Wed, Jan 27, 2016</time>
  <h2 id="简介">简介</h2>
<p>在一个网络服务器不间断运行过程中，有一些资源数据需要实时更新，例如需要及时更新一份白名单列表，怎么做才能做到优雅无损的更新到服务的进程空间内？这里我们提出一种叫“双缓冲”的技术来解决这种问题。</p>
<p>这里的双缓冲技术是借鉴了计算机屏幕绘图领域的概念。双缓冲技术绘图即在内存中创建一个与屏幕绘图区域一致的对象，先将图形绘制到内存中的这个对象上，再一次性将这个对象上的图形拷贝到屏幕上，这样能大大加快绘图的速度。</p>
<h3 id="问题抽象">问题抽象</h3>
<p>假设我们有一个查询服务，为了方便描述，我们将数据加密传输等一些不必要的细节都省去后，请求报文可以抽象成两个参数：一个是id，用来唯一标识一台设备（例如手机或电脑）；另一个查询主体query。服务端业务逻辑是通过query查询数据库/NoSQL等数据引擎然后返回相应的数据，同时记录一条请求日志。</p>
<p>用Golang来实现这个逻辑如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;net/http&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Query</span>(<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) <span style="color:#66d9ef">string</span> {
	<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">&#34;id&#34;</span>)
	<span style="color:#a6e22e">query</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">&#34;query&#34;</span>)

	<span style="color:#75715e">//参数合法性检查
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//具体的业务逻辑，查询数据库/NoSQL等数据引擎，然后做逻辑计算，然后合并结果
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//这里简单抽象，直接返回欢迎语
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;hello, %v&#34;</span>, <span style="color:#a6e22e">id</span>)

	<span style="color:#75715e">// 记录一条查询日志，用于离线统计和分析
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;&lt;id=%v&gt;&lt;query=%v&gt;&lt;result=%v&gt;&lt;ip=%v&gt;&#34;</span>, <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">query</span>, <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">RemoteAddr</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Handler</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ParseForm</span>()
	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Query</span>(<span style="color:#a6e22e">r</span>)
	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#a6e22e">result</span>))
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/q&#34;</span>, <span style="color:#a6e22e">Handler</span>)
	<span style="color:#a6e22e">hostname</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Hostname</span>()
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;start http://%s:8091/q&#34;</span>, <span style="color:#a6e22e">hostname</span>)
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8091&#34;</span>, <span style="color:#66d9ef">nil</span>))
}
</code></pre></div><p>服务上线一段时间后，通过日志分析发现有一些id发起的请求异常，每天的请求量远远高于其他id，我们有理由怀疑这些请求是竞争对手在抓我们的数据。这个时候就开始进入攻防阶段了。</p>
<p>有几种攻防策略可供选择：</p>
<ol>
<li>直接封IP，这种策略有可能会误杀一些正常用户。</li>
<li>将id加入黑名单</li>
</ol>
<p>假设我们将策略1放到前端接入服务处(例如Nginx)进行拦截，策略2在我们自己的业务逻辑中实现，即在Query函数中加入对id的判断即可。现在的完整代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;net/http&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io/ioutil&#34;</span>
	<span style="color:#e6db74">&#34;bytes&#34;</span>
	<span style="color:#e6db74">&#34;strings&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">blackIDs</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">int</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">LoadBlackIDs</span>(<span style="color:#a6e22e">filepath</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#75715e">// 加载黑名单列表文件，每行一个
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">b</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#a6e22e">filepath</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewBuffer</span>(<span style="color:#a6e22e">b</span>)
	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ReadString</span>(<span style="color:#e6db74">&#39;\n&#39;</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">id</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">TrimSpace</span>(<span style="color:#a6e22e">id</span>)
			<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">id</span>) &gt; <span style="color:#ae81ff">0</span> {
				<span style="color:#a6e22e">blackIDs</span>[<span style="color:#a6e22e">id</span>] = <span style="color:#ae81ff">1</span>
			}
		}

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">break</span>
		}
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">IsBlackID</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">exist</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">blackIDs</span>[<span style="color:#a6e22e">id</span>]
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">exist</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Query</span>(<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">&#34;id&#34;</span>)
	<span style="color:#a6e22e">query</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">&#34;query&#34;</span>)

	<span style="color:#75715e">//参数合法性检查
</span><span style="color:#75715e"></span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">IsBlackID</span>(<span style="color:#a6e22e">id</span>) {
		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;ERROR&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;ERROR id&#34;</span>)
	}

	<span style="color:#75715e">//具体的业务逻辑，查询数据库/NoSQL等数据引擎，然后做逻辑计算，然后合并结果
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//这里简单抽象，直接返回欢迎语
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;hello, %v&#34;</span>, <span style="color:#a6e22e">id</span>)

	<span style="color:#75715e">// 记录一条查询日志，用于离线统计和分析
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;&lt;id=%v&gt;&lt;query=%v&gt;&lt;result=%v&gt;&lt;ip=%v&gt;&#34;</span>, <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">query</span>, <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">RemoteAddr</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Handler</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ParseForm</span>()
	<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Query</span>(<span style="color:#a6e22e">r</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#a6e22e">result</span>))
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#ae81ff">403</span>)
		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#a6e22e">result</span>))
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">blackIDs</span> = make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">int</span>)
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span> {
		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">LoadBlackIDs</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">1</span>])
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			panic(<span style="color:#a6e22e">err</span>)
		}
	}

	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/q&#34;</span>, <span style="color:#a6e22e">Handler</span>)
	<span style="color:#a6e22e">hostname</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Hostname</span>()
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;start http://%s:8091/q&#34;</span>, <span style="color:#a6e22e">hostname</span>)
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8091&#34;</span>, <span style="color:#66d9ef">nil</span>))
}
</code></pre></div><p>经过上述努力，终于将一些异常请求屏蔽掉了，一看时间都凌晨了，恩，好好回家碎个叫，累死哥了。</p>
<h3 id="解决思路">解决思路</h3>
<p>又过了一些日子，产品妹子还是找过来了，说我们的最新数据又被竞争对手抓走了，肿么回事？
我们只能做一个离线流程将恶意id实时过滤出来，然后及时反馈到在线服务中去，
一开始想到可以通过重启进程的方式来加载这份black_id.txt，这就要求我们的程序对reload要做到足够优雅，
例如不能丢请求、reload过程中要足够平滑，短时间做到这一点还有些困难。另外，整个程序reload过程所消耗的CPU/IO资源较多，例如一些不需更新的资源也需要reload。
如果能做到按需加载就更好了，即：哪个资源有变化，我们就只加载那个资源。
然后我们就想到了本文所提到的双缓冲技术。</p>
<p>这里的双缓冲技术是指对black_id.txt文件的加载过程是在后台独立加载，等加载完毕之后，再与当前正在使用的对象直接交换一下，即可完成新文件的加载。
这里有几个细节需要讨论一下：</p>
<ol>
<li>black_id.txt在内存中是一个map结构，有人说，等有更新时，直接将增量更新进map即可，这就需要对该map结构上锁，且所有用到的地方都加锁，锁粒度有点粗</li>
<li>一个简单直接的办法是对black_id.txt整体重新生成一个新的map结构，使用的时候直接拿到这个map的指针替换掉原来的指针即可</li>
<li>新老替换后，老的资源什么释放？在Golang中，一般情况下可以通过其自身的GC来释放即可。但有时候，有一些资源是需要我们自己主动释放的，GC这一点做不到，例如通过CGO方式嵌入进来的C扩展对象的释放工作。这里我们通过引用计数技术来解决。</li>
</ol>
<h3 id="双缓冲技术golang实现">双缓冲技术Golang实现</h3>
<p>直接上代码。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;io/ioutil&#34;</span>
	<span style="color:#e6db74">&#34;crypto/md5&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
	<span style="color:#e6db74">&#34;sync/atomic&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DoubleBufferingTarget</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Initialize</span>(<span style="color:#a6e22e">conf</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> <span style="color:#75715e">// 初始化，继承类可以在此做一些初始化的工作
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Close</span>() <span style="color:#75715e">// 继承类如果在Initialize函数中申请了一些资源，可以在这里将这些资源进行回收
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DoubleBufferingTargetCreator</span> <span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">DoubleBufferingTarget</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DoubleBufferingTargetRef</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Target</span> <span style="color:#a6e22e">DoubleBufferingTarget</span>
	<span style="color:#a6e22e">ref</span>    <span style="color:#f92672">*</span><span style="color:#66d9ef">int32</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DoubleBuffering</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">creator</span>         <span style="color:#a6e22e">DoubleBufferingTargetCreator</span>

	<span style="color:#a6e22e">mutex</span>           <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
	<span style="color:#a6e22e">refTarget</span>       <span style="color:#a6e22e">DoubleBufferingTargetRef</span>

	<span style="color:#a6e22e">reloadTimestamp</span> <span style="color:#66d9ef">int64</span>
	<span style="color:#a6e22e">md5h</span>            <span style="color:#66d9ef">string</span>
}


<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newDoubleBuffering</span>(<span style="color:#a6e22e">f</span> <span style="color:#a6e22e">DoubleBufferingTargetCreator</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">DoubleBuffering</span> {
	<span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">DoubleBuffering</span>)
	<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">creator</span> = <span style="color:#a6e22e">f</span>
	<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">reloadTimestamp</span> = <span style="color:#ae81ff">0</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">d</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DoubleBuffering</span>) <span style="color:#a6e22e">reload</span>(<span style="color:#a6e22e">conf</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">creator</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Initialize</span>(<span style="color:#a6e22e">conf</span>) <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
	}

	<span style="color:#a6e22e">content</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#a6e22e">conf</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">content</span> = []byte(<span style="color:#a6e22e">conf</span>)
	}
	<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">md5h</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprint</span>(<span style="color:#e6db74">&#34;%x&#34;</span>, <span style="color:#a6e22e">md5</span>.<span style="color:#a6e22e">Sum</span>(<span style="color:#a6e22e">content</span>))
	<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">reloadTimestamp</span> = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Unix</span>()

	<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">refTarget</span>.<span style="color:#a6e22e">Release</span>() <span style="color:#75715e">// 将老对象释放掉
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">refTarget</span>.<span style="color:#a6e22e">Target</span> = <span style="color:#a6e22e">t</span>
	<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">refTarget</span>.<span style="color:#a6e22e">ref</span> = new(<span style="color:#66d9ef">int32</span>)
	<span style="color:#f92672">*</span><span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">refTarget</span>.<span style="color:#a6e22e">ref</span> = <span style="color:#ae81ff">1</span> <span style="color:#75715e">// 初始设置为1，由DoubleBuffering代为管理
</span><span style="color:#75715e"></span>
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
}

<span style="color:#75715e">// ReloadTimestamp return the latest timestamp when the DoubleBuffering reloaded at the last time
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DoubleBuffering</span>) <span style="color:#a6e22e">ReloadTimestamp</span>() <span style="color:#66d9ef">int64</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">reloadTimestamp</span>
}

<span style="color:#75715e">// LatestConfMD5 return the latest config&#39;s md5
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DoubleBuffering</span>) <span style="color:#a6e22e">LatestConfMD5</span>() <span style="color:#66d9ef">string</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">md5h</span>
}

<span style="color:#75715e">// Get return the target this DoubleBuffering manipulated.
</span><span style="color:#75715e">// You should call DoubleBufferingTargetRef.Release() function after you have used it.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DoubleBuffering</span>) <span style="color:#a6e22e">Get</span>() <span style="color:#a6e22e">DoubleBufferingTargetRef</span> {
	<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">refTarget</span>.<span style="color:#a6e22e">ref</span>, <span style="color:#ae81ff">1</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">refTarget</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#a6e22e">DoubleBufferingTargetRef</span>) <span style="color:#a6e22e">Release</span>() {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">ref</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">ref</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Target</span>.<span style="color:#a6e22e">Close</span>()
	}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#a6e22e">DoubleBufferingTargetRef</span>) <span style="color:#a6e22e">Ref</span>() <span style="color:#66d9ef">int32</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">ref</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">ref</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DoubleBufferingMap</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span><span style="color:#75715e">/*name*/</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">DoubleBuffering</span>
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DoubleBufferingManager</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">targets</span> <span style="color:#a6e22e">DoubleBufferingMap</span>
	<span style="color:#a6e22e">mutex</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewDoubleBufferingManager</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">DoubleBufferingManager</span> {
	<span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">DoubleBufferingManager</span>)
	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">targets</span> = make(<span style="color:#a6e22e">DoubleBufferingMap</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DoubleBufferingManager</span>) <span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">conf</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">f</span> <span style="color:#a6e22e">DoubleBufferingTargetCreator</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newDoubleBuffering</span>(<span style="color:#a6e22e">f</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">reload</span>(<span style="color:#a6e22e">conf</span>) {
		<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">targets</span>[<span style="color:#a6e22e">name</span>] = <span style="color:#a6e22e">d</span>
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DoubleBufferingManager</span>) <span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">DoubleBuffering</span> {
	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">targets</span>[<span style="color:#a6e22e">name</span>]; <span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">t</span>
	}

	<span style="color:#75715e">//panic(&#34;cannot find this kind of DoubleBuffering&#34;)
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DoubleBufferingManager</span>) <span style="color:#a6e22e">Reload</span>(<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">conf</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">name</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">d</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">reload</span>(<span style="color:#a6e22e">conf</span>)
}
</code></pre></div><h3 id="使用doublebuffering改造最开始那个抽象问题">使用DoubleBuffering改造最开始那个抽象问题</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;net/http&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io/ioutil&#34;</span>
	<span style="color:#e6db74">&#34;bytes&#34;</span>
	<span style="color:#e6db74">&#34;strings&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">BlackIDDict</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">blackIDs</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">int</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewBlackIDDict</span>() <span style="color:#a6e22e">DoubleBufferingTarget</span> {
	<span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">BlackIDDict</span>{
		<span style="color:#a6e22e">blackIDs</span>: make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">int</span>),
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">d</span>
}

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">dbm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DoubleBufferingManager</span>

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">BlackIDDict</span>) <span style="color:#a6e22e">Initialize</span>(<span style="color:#a6e22e">conf</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#a6e22e">filepath</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conf</span>

	<span style="color:#75715e">// 加载黑名单列表文件，每行一个
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">b</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#a6e22e">filepath</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
	}
	<span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewBuffer</span>(<span style="color:#a6e22e">b</span>)
	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ReadString</span>(<span style="color:#e6db74">&#39;\n&#39;</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">id</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">TrimSpace</span>(<span style="color:#a6e22e">id</span>)
			<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">id</span>) &gt; <span style="color:#ae81ff">0</span> {
				<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">blackIDs</span>[<span style="color:#a6e22e">id</span>] = <span style="color:#ae81ff">1</span>
			}
		}

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">break</span>
		}
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">BlackIDDict</span>) <span style="color:#a6e22e">Close</span>() {
	<span style="color:#75715e">// 在这里做一些资源释放工作
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 当前这个例子没有资源需要我们手工释放
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">BlackIDDict</span>) <span style="color:#a6e22e">IsBlackID</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">exist</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">blackIDs</span>[<span style="color:#a6e22e">id</span>]
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">exist</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Query</span>(<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">&#34;id&#34;</span>)
	<span style="color:#a6e22e">query</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">&#34;query&#34;</span>)

	<span style="color:#75715e">//TODO 参数合法性检查
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dbm</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;black_id&#34;</span>)
	<span style="color:#a6e22e">tg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Get</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">tg</span>.<span style="color:#a6e22e">Release</span>()
	<span style="color:#a6e22e">dict</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tg</span>.<span style="color:#a6e22e">Target</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">BlackIDDict</span>)  <span style="color:#75715e">// 转换为具体的Dict对象
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">dict</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;ERROR, Convert DoubleBufferingTarget to Dict failed&#34;</span>)
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">dict</span>.<span style="color:#a6e22e">IsBlackID</span>(<span style="color:#a6e22e">id</span>) {
		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;ERROR&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;ERROR id&#34;</span>)
	}

	<span style="color:#75715e">//具体的业务逻辑，查询数据库/NoSQL等数据引擎，然后做逻辑计算，然后合并结果
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//这里简单抽象，直接返回欢迎语
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;hello, %v&#34;</span>, <span style="color:#a6e22e">id</span>)

	<span style="color:#75715e">// 记录一条查询日志，用于离线统计和分析
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;&lt;id=%v&gt;&lt;query=%v&gt;&lt;result=%v&gt;&lt;ip=%v&gt;&#34;</span>, <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">query</span>, <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">RemoteAddr</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Handler</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ParseForm</span>()
	<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Query</span>(<span style="color:#a6e22e">r</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#a6e22e">result</span>))
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#ae81ff">403</span>)
		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#a6e22e">result</span>))
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Reload</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
	<span style="color:#75715e">// 这里简化处理，直接重新加载black_id。如果有多个，可以从url参数中获取资源名称
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">dbm</span>.<span style="color:#a6e22e">Reload</span>(<span style="color:#e6db74">&#34;black_id&#34;</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">1</span>]) {
		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;OK&#34;</span>))
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;FAILED&#34;</span>))
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">2</span> {
		panic(<span style="color:#e6db74">&#34;Not specify black_id.txt&#34;</span>)
	}

	<span style="color:#a6e22e">dbm</span> = <span style="color:#a6e22e">NewDoubleBufferingManager</span>()
	<span style="color:#a6e22e">rc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dbm</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#e6db74">&#34;black_id&#34;</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">1</span>], <span style="color:#a6e22e">NewBlackIDDict</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rc</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> {
		panic(<span style="color:#e6db74">&#34;black_id initialize failed&#34;</span>)
	}

	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/q&#34;</span>, <span style="color:#a6e22e">Handler</span>)
	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/admin/reload&#34;</span>, <span style="color:#a6e22e">Reload</span>) <span style="color:#75715e">// 管理接口，用于重新加载black_id.txt。如果有多个这种资源，可以增加一些参数来说区分不同的资源
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">hostname</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Hostname</span>()
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;start http://%s:8091/q&#34;</span>, <span style="color:#a6e22e">hostname</span>)
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8091&#34;</span>, <span style="color:#66d9ef">nil</span>))
}
</code></pre></div><p>程序启动之后，使用black_id.txt里面的id请求时，都会返回403，如果有新增的black_id，我们也加入到black_id.txt文件中，然后调用 <code>/admin/reload</code> 接口使之生效即可。</p>
<h3 id="c版本实现">C++版本实现</h3>
<p>//TODO</p>
<h2 id="参考文献">参考文献</h2>
<ol>
<li><a href="http://baike.haosou.com/doc/302938-320692.html">双缓冲技术介绍</a></li>
<li><a href="https://github.com/zieckey/dbuf">Golang实现的示例源码在这里 https://github.com/zieckey/dbuf</a></li>
</ol>

</div>


    </main>

    
      
    
  </body>
</html>
