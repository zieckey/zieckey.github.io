<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.89.4" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Nginx源码研究（3）——Nginx数组ngx_array_t和示例 &middot; CodeG Blog</title>
  <meta name="description" content="本文主要介绍Nginx数组ngx_array_t这一重要的数据结构的使用方法和具体实现。" />

  
  <link type="text/css" rel="stylesheet" href="http://zieckey.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="http://zieckey.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="http://zieckey.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="http://zieckey.github.io/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://zieckey.github.io/"><h1>CodeG Blog</h1></a>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="http://zieckey.github.io/">Home</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2021. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Nginx源码研究（3）——Nginx数组ngx_array_t和示例</h1>
  <time datetime=2015-01-03T00:00:00Z class="post-date">Sat, Jan 3, 2015</time>
  <p>本文主要介绍Nginx数组<code>ngx_array_t</code>这一重要的数据结构的使用方法和具体实现。</p>
<p><code>ngx_array_t</code>是nginx内部使用的数组结构。nginx的数组结构在存储上与大家认知的C语言内置的数组有相似性，比如实际上存储数据的区域也是一大块连续的内存。但是数组除了存储数据的内存以外还包含一些元信息来描述相关的一些信息。ngx_array_t的定义位于<code>src/core/ngx_array.{c,h}</code>里面。</p>
<p>ngx_array.h实现和注释如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ngx_config.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ngx_core.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// 动态数组
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> ngx_array_s {
    <span style="color:#75715e">// elts指向数组的首地址
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span>        <span style="color:#f92672">*</span>elts; 
    <span style="color:#75715e">// nelts是数组中已经使用的元素个数
</span><span style="color:#75715e"></span>    ngx_uint_t   nelts; 
    <span style="color:#75715e">// 每个数组元素占用的内存大小
</span><span style="color:#75715e"></span>    size_t       size;  
    <span style="color:#75715e">// 当前数组中能够容纳元素个数的总大小
</span><span style="color:#75715e"></span>    ngx_uint_t   nalloc; 
    <span style="color:#75715e">// 内存池对象
</span><span style="color:#75715e"></span>    ngx_pool_t  <span style="color:#f92672">*</span>pool;  
};

<span style="color:#75715e">/*
</span><span style="color:#75715e">从内存池中创建n个元素的数组，元素大小为size
</span><span style="color:#75715e">创建一个新的数组对象，并返回这个对象。
</span><span style="color:#75715e">
</span><span style="color:#75715e">p:	数组分配内存使用的内存池；
</span><span style="color:#75715e">n:	数组的初始容量大小，即在不扩容的情况下最多可以容纳的元素个数。
</span><span style="color:#75715e">size:	单个元素的大小，单位是字节。
</span><span style="color:#75715e">
</span><span style="color:#75715e">注意事项: 由于使用ngx_palloc分配内存，数组在扩容时，旧的内存不会被释放，会造成内存的浪费。
</span><span style="color:#75715e">因此，最好能提前规划好数组的容量，在创建或者初始化的时候一次搞定，避免多次扩容，造成内存浪费。
</span><span style="color:#75715e"> */</span>
ngx_array_t <span style="color:#f92672">*</span><span style="color:#a6e22e">ngx_array_create</span>(ngx_pool_t <span style="color:#f92672">*</span>p, ngx_uint_t n, size_t size);

<span style="color:#75715e">// 销毁该数组对象，并释放其分配的内存回内存池。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ngx_array_destroy</span>(ngx_array_t <span style="color:#f92672">*</span>a);

<span style="color:#75715e">// 在数组a上新追加一个元素，并返回指向新元素的指针。
</span><span style="color:#75715e">// 需要把返回的指针使用类型转换，转换为具体的类型，然后再给新元素本身或者是各字段（如果数组的元素是复杂类型）赋值。
</span><span style="color:#75715e">// 如果数组已满，则重新分配两倍（nalloc*size)的内存空间，且nalloc更新为2*nalloc
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ngx_array_push</span>(ngx_array_t <span style="color:#f92672">*</span>a);

<span style="color:#75715e">// 返回将要添加n个元素到数组中其首个元素的地址
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ngx_array_push_n</span>(ngx_array_t <span style="color:#f92672">*</span>a, ngx_uint_t n);


<span style="color:#75715e">// 如果一个数组对象是被分配在堆上的，那么当调用ngx_array_destroy销毁以后，如果想再次使用，就可以调用此函数。
</span><span style="color:#75715e">// 如果一个数组对象是被分配在栈上的，那么就需要调用此函数，进行初始化的工作以后，才可以使用。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> ngx_inline ngx_int_t
<span style="color:#a6e22e">ngx_array_init</span>(ngx_array_t <span style="color:#f92672">*</span>array, ngx_pool_t <span style="color:#f92672">*</span>pool, ngx_uint_t n, size_t size)
{
    <span style="color:#75715e">/*
</span><span style="color:#75715e">     * set &#34;array-&gt;nelts&#34; before &#34;array-&gt;elts&#34;, otherwise MSVC thinks
</span><span style="color:#75715e">     * that &#34;array-&gt;nelts&#34; may be used without having been initialized
</span><span style="color:#75715e">     */</span>

    array<span style="color:#f92672">-&gt;</span>nelts <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    array<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">=</span> size;
    array<span style="color:#f92672">-&gt;</span>nalloc <span style="color:#f92672">=</span> n;
    array<span style="color:#f92672">-&gt;</span>pool <span style="color:#f92672">=</span> pool;

    array<span style="color:#f92672">-&gt;</span>elts <span style="color:#f92672">=</span> ngx_palloc(pool, n <span style="color:#f92672">*</span> size);
    <span style="color:#66d9ef">if</span> (array<span style="color:#f92672">-&gt;</span>elts <span style="color:#f92672">==</span> NULL) {
        <span style="color:#66d9ef">return</span> NGX_ERROR;
    }

    <span style="color:#66d9ef">return</span> NGX_OK;
}
</code></pre></div><p>测试代码，完整的工程编译请参考 <a href="https://github.com/zieckey/nginx-research">https://github.com/zieckey/nginx-research项目</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cPP" data-lang="cPP"><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;allinc.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">User</span> {
    ngx_str_t name;
    ngx_str_t url;
    <span style="color:#66d9ef">int</span> id;
};

<span style="color:#75715e">/*
</span><span style="color:#75715e">* 
</span><span style="color:#75715e">*/</span>
TEST_UNIT(ngx_array_t) {
    ngx_array_t<span style="color:#f92672">*</span> a <span style="color:#f92672">=</span> ngx_array_create(g_pool, <span style="color:#ae81ff">10</span>, <span style="color:#66d9ef">sizeof</span>(User));

    H_TEST_ASSERT(a<span style="color:#f92672">-&gt;</span>nalloc <span style="color:#f92672">==</span> <span style="color:#ae81ff">10</span>);
    H_TEST_ASSERT(a<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">==</span> <span style="color:#66d9ef">sizeof</span>(User));

    <span style="color:#75715e">// Add one element to the array
</span><span style="color:#75715e"></span>    User<span style="color:#f92672">*</span> u <span style="color:#f92672">=</span> (User<span style="color:#f92672">*</span>)ngx_array_push(a);
    u<span style="color:#f92672">-&gt;</span>name.data <span style="color:#f92672">=</span> (u_char<span style="color:#f92672">*</span>)ngx_pcalloc(g_pool, <span style="color:#ae81ff">32</span>);
    strcpy((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)u<span style="color:#f92672">-&gt;</span>name.data, <span style="color:#e6db74">&#34;CodeG&#34;</span>);
    u<span style="color:#f92672">-&gt;</span>name.len <span style="color:#f92672">=</span> strlen(<span style="color:#e6db74">&#34;CodeG&#34;</span>);
    ngx_str_set(<span style="color:#f92672">&amp;</span>u<span style="color:#f92672">-&gt;</span>url, <span style="color:#e6db74">&#34;http://blog.codeg.cn/2015/01/03/ngx_array_t&#34;</span>);
    u<span style="color:#f92672">-&gt;</span>id <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    H_TEST_ASSERT(a<span style="color:#f92672">-&gt;</span>nelts <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>);
    H_TEST_ASSERT(a<span style="color:#f92672">-&gt;</span>elts <span style="color:#f92672">==</span> u); <span style="color:#75715e">// elts指向数组的首地址，因此与第一个数组元素地址相同
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// Add another one element to the array
</span><span style="color:#75715e"></span>    u <span style="color:#f92672">=</span> (User<span style="color:#f92672">*</span>)ngx_array_push(a);
    u<span style="color:#f92672">-&gt;</span>name.data <span style="color:#f92672">=</span> (u_char<span style="color:#f92672">*</span>)ngx_pcalloc(g_pool, <span style="color:#ae81ff">32</span>);
    strcpy((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)u<span style="color:#f92672">-&gt;</span>name.data, <span style="color:#e6db74">&#34;zieckey&#34;</span>);
    u<span style="color:#f92672">-&gt;</span>name.len <span style="color:#f92672">=</span> strlen(<span style="color:#e6db74">&#34;zieckey&#34;</span>);
    ngx_str_set(<span style="color:#f92672">&amp;</span>u<span style="color:#f92672">-&gt;</span>url, <span style="color:#e6db74">&#34;http://blog.codeg.cn/2014/12/13/Hello-CodeG&#34;</span>);
    u<span style="color:#f92672">-&gt;</span>id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    H_TEST_ASSERT(a<span style="color:#f92672">-&gt;</span>nelts <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>);

    <span style="color:#75715e">// Add 3rd element to the array
</span><span style="color:#75715e"></span>    u <span style="color:#f92672">=</span> (User<span style="color:#f92672">*</span>)ngx_array_push(a);
    u<span style="color:#f92672">-&gt;</span>name.data <span style="color:#f92672">=</span> (u_char<span style="color:#f92672">*</span>)ngx_pcalloc(g_pool, <span style="color:#ae81ff">32</span>);
    strcpy((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)u<span style="color:#f92672">-&gt;</span>name.data, <span style="color:#e6db74">&#34;zieckey&#34;</span>);
    u<span style="color:#f92672">-&gt;</span>name.len <span style="color:#f92672">=</span> strlen(<span style="color:#e6db74">&#34;zieckey&#34;</span>);
    ngx_str_set(<span style="color:#f92672">&amp;</span>u<span style="color:#f92672">-&gt;</span>url, <span style="color:#e6db74">&#34;https://github.com/zieckey&#34;</span>);
    u<span style="color:#f92672">-&gt;</span>id <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
    H_TEST_ASSERT(a<span style="color:#f92672">-&gt;</span>nelts <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>);

    <span style="color:#75715e">// Traversal the array
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (ngx_uint_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> a<span style="color:#f92672">-&gt;</span>nelts; <span style="color:#f92672">++</span>i) {
        u <span style="color:#f92672">=</span> (User<span style="color:#f92672">*</span>)((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)a<span style="color:#f92672">-&gt;</span>elts <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(User)<span style="color:#f92672">*</span>i);
        H_TEST_ASSERT(u<span style="color:#f92672">-&gt;</span>id <span style="color:#f92672">==</span> i);
        printf(<span style="color:#e6db74">&#34;id=%d name=[%s] url=[%s]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, u<span style="color:#f92672">-&gt;</span>id, (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)u<span style="color:#f92672">-&gt;</span>name.data, (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)u<span style="color:#f92672">-&gt;</span>url.data);
    }
}

</code></pre></div><p>上述代码输出如下：</p>
<pre><code>id=0 name=[CodeG] url=[http://blog.codeg.cn/2015/01/03/ngx_array_t]
id=1 name=[zieckey] url=[http://blog.codeg.cn/2014/12/13/Hello-CodeG]
id=2 name=[zieckey] url=[https://github.com/zieckey]
</code></pre>
<h3 id="参考">参考：</h3>
<ul>
<li><a href="http://tengine.taobao.org/book/chapter_02.html#ngx-array-t-100">淘宝：Nginx开发从入门到精通 http://tengine.taobao.org/book/chapter_02.html#ngx-array-t-100</a></li>
<li><a href="https://github.com/zieckey/nginx-1.0.14_comment/blob/master/src/core/ngx_array.h">nginx源码注释 https://github.com/zieckey/nginx-1.0.14_comment/blob/master/src/core/ngx_array.h</a></li>
<li><a href="https://github.com/zieckey/nginx-1.0.14_comment/blob/master/src/core/ngx_array.c">nginx源码注释 https://github.com/zieckey/nginx-1.0.14_comment/blob/master/src/core/ngx_array.c</a></li>
</ul>

</div>


    </main>

    
      
    
  </body>
</html>
