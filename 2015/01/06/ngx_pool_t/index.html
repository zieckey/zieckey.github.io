<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.127.0">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Nginx源码研究（7）——内存池结构ngx_pool_t &middot; CodeG Blog</title>
  <meta name="description" content="本文主要介绍Nginx内存池结构`ngx_pool_t`这一重要的数据结构的使用方法和具体实现。同时为了方便学习和研究，还从`ngx_pool_t`抽取了一个完全独立的`cg_pool_t`结构，不依赖Nginx，也不依赖任何第三方类库，可以直接将源码拿走集成进现有系统中。" />

  
  <link type="text/css" rel="stylesheet" href="https://blog.codeg.cn/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://blog.codeg.cn/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://blog.codeg.cn/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://blog.codeg.cn/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://blog.codeg.cn/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://blog.codeg.cn/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://blog.codeg.cn/"><h1>CodeG Blog</h1></a>
      <p class="lead">
       思路决定出路，态度决定高度。 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://blog.codeg.cn/">Home</a> </li>
        <li><a href="https://blog.codeg.cn/categories/"> 归档 </a></li><li><a href="https://blog.codeg.cn/post/"> 技术文章 </a></li><li><a href="https://blog.codeg.cn/about/"> 关于我 </a></li>
      </ul>
    </nav>

    <p>&copy; 2024. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Nginx源码研究（7）——内存池结构ngx_pool_t</h1>
  <time datetime=2015-01-06T00:00:00Z class="post-date">Tue, Jan 6, 2015</time>
  <h2 id="简介">简介</h2>
<p>本文主要介绍Nginx内存池结构<code>ngx_pool_t</code>这一重要的数据结构的使用方法和具体实现。同时为了方便学习和研究，还从<code>ngx_pool_t</code>抽取了一个完全独立的<code>cg_pool_t</code>结构，不依赖Nginx，也不依赖任何第三方类库，可以直接将源码拿走集成进现有系统中。</p>
<p>典型的应用场景是这样的，假如你有一个nginx扩展，用到了ngx_pool_t这个数据结构，但是现在有一个需求是需要将这份扩展代码独立出来，不依赖nginx运行，那么这个<code>cg_pool_t</code>是你的好帮手，你几乎只需要将头文件从<code>ngx_palloc.h</code>换为<code>cg_pool.h</code>即可，代码完全不用修改即可完成移植。</p>
<p>Nginx的内存池在大量的小块内存的申请和释放的时候，能更快地进行内存分配（对比malloc和free），同时减少内存碎片，防止内存泄露。尤其是在防止内存泄露方面，Nginx的内存池的设计可谓非常巧妙。调用者可以一直在一个<code>ngx_pool_t</code>上调用ngx_palloc申请内存，而只需在最后释放这个<code>ngx_pool_t</code>对象即可将中途所有申请的内存统统一块释放掉。从而大大减少内存泄露的可能性，也大大简化c程序的开发逻辑流程。</p>
<h2 id="nginx内存池源代码位置">Nginx内存池源代码位置</h2>
<p>src/core/ngx_palloc.{h,c}</p>
<h2 id="cg_pool_t内存池的源码位置">cg_pool_t内存池的源码位置</h2>
<p><a href="https://github.com/zieckey/nginx-research/tree/master/libnginx/pool">https://github.com/zieckey/nginx-research/tree/master/libnginx/pool</a></p>
<h2 id="源码分析">源码分析</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">ngx_pool_large_s</span>  <span class="kt">ngx_pool_large_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//大内存结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="n">ngx_pool_large_s</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ngx_pool_large_t</span>     <span class="o">*</span><span class="n">next</span><span class="p">;</span> <span class="c1">//下一个大块内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span>                 <span class="o">*</span><span class="n">alloc</span><span class="p">;</span><span class="c1">//nginx分配的大块内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//该结构用来维护内存池的数据块，供用户分配之用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u_char</span>               <span class="o">*</span><span class="n">last</span><span class="p">;</span>  <span class="c1">//当前内存分配结束位置，即下一段可分配内存的起始位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">u_char</span>               <span class="o">*</span><span class="n">end</span><span class="p">;</span>   <span class="c1">//内存池结束位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">ngx_pool_t</span>           <span class="o">*</span><span class="n">next</span><span class="p">;</span>  <span class="c1">//链接到下一个内存池
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">ngx_uint_t</span>            <span class="n">failed</span><span class="p">;</span><span class="c1">//统计该内存池不能满足分配请求的次数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="kt">ngx_pool_data_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//该结构维护整个内存池的头部信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="n">ngx_pool_s</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ngx_pool_data_t</span>       <span class="n">d</span><span class="p">;</span>       <span class="c1">//数据块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">size_t</span>                <span class="n">max</span><span class="p">;</span>     <span class="c1">//数据块大小，即小块内存的最大值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">ngx_pool_t</span>           <span class="o">*</span><span class="n">current</span><span class="p">;</span> <span class="c1">//保存当前内存值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">ngx_chain_t</span>          <span class="o">*</span><span class="n">chain</span><span class="p">;</span>   <span class="c1">//可以挂一个chain结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">ngx_pool_large_t</span>     <span class="o">*</span><span class="n">large</span><span class="p">;</span>   <span class="c1">//分配大块内存用，即超过max的内存请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">ngx_pool_cleanup_t</span>   <span class="o">*</span><span class="n">cleanup</span><span class="p">;</span> <span class="c1">//挂载一些内存池释放的时候，同时释放的资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">ngx_log_t</span>            <span class="o">*</span><span class="n">log</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><h2 id="内存结构图">内存结构图</h2>
<p><a href="https://blog.codeg.cn/images/githubpages/nginx/ngx_pool_t_xiekeli.png"><img src="https://blog.codeg.cn/images/githubpages/nginx/ngx_pool_t_xiekeli.png" alt=""></a>
备注：从参考博客5摘录</p>
<p><a href="https://blog.codeg.cn/images/githubpages/nginx/ngx_pool_t_rainx.png"><img src="https://blog.codeg.cn/images/githubpages/nginx/ngx_pool_t_rainx.png" alt=""></a>
备注：从参考文档6摘录</p>
<h2 id="测试代码">测试代码</h2>
<p>该测试代码的完整工程的编译和运行方式请参考 <a href="https://github.com/zieckey/nginx-research">https://github.com/zieckey/nginx-research项目</a>。Linux&amp;Windows都测试通过。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">TEST_UNIT</span><span class="p">(</span><span class="n">ngx_pool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ngx_pool_t</span><span class="o">*</span> <span class="n">pool</span> <span class="o">=</span> <span class="nf">ngx_create_pool</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="nf">ngx_palloc</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&#34;hello world</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">strcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">H_TEST_ASSERT</span><span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="nf">ngx_palloc</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span> <span class="c1">// alloc a large block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">ngx_destroy_pool</span><span class="p">(</span><span class="n">pool</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="参考">参考：</h2>
<ol>
<li><a href="http://tengine.taobao.org/book/chapter_02.html#ngx-palloc-t-100">淘宝：Nginx开发从入门到精通 http://tengine.taobao.org/book/chapter_02.html#ngx-queue-t-100</a></li>
<li><a href="https://github.com/zieckey/nginx-1.0.14_comment/blob/master/src/core/ngx_palloc.h">nginx源码注释 https://github.com/zieckey/nginx-1.0.14_comment/blob/master/src/core/ngx_palloc.h</a></li>
<li><a href="https://github.com/zieckey/nginx-1.0.14_comment/blob/master/src/core/ngx_palloc.c">nginx源码注释 https://github.com/zieckey/nginx-1.0.14_comment/blob/master/src/core/ngx_palloc.c</a></li>
<li><a href="http://blog.csdn.net/v_july_v/article/details/7040425">Nginx源码剖析之内存池，与内存管理 http://blog.csdn.net/v_july_v/article/details/7040425</a></li>
<li><a href="http://www.cnblogs.com/xiekeli/archive/2012/10/17/2727432.html">nginx源码学习&mdash;-内存池 http://www.cnblogs.com/xiekeli/archive/2012/10/17/2727432.html</a></li>
<li><a href="https://code.google.com/p/nginxsrp/wiki/NginxCodeReview">nginx源码研究 https://code.google.com/p/nginxsrp/wiki/NginxCodeReview</a></li>
</ol>

</div>


    </main>

    
      
  


    
  </body>
</html>
