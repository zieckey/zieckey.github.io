<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.89.4" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Golang开源项目源码阅读 &middot; CodeG Blog</title>
  <meta name="description" content="本文是关于用Golang实现的一些开源项目的简介和源码阅读" />

  
  <link type="text/css" rel="stylesheet" href="http://zieckey.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="http://zieckey.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="http://zieckey.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="http://zieckey.github.io/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://zieckey.github.io/"><h1>CodeG Blog</h1></a>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="http://zieckey.github.io/">Home</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2021. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Golang开源项目源码阅读</h1>
  <time datetime=2015-09-19T00:00:00Z class="post-date">Sat, Sep 19, 2015</time>
  <h2 id="总览">总览</h2>
<h3 id="githubcomjulienschmidthttproute">github.com/julienschmidt/httproute</h3>
<p><a href="https://github.com/julienschmidt/httprouter" title="httprouter">httprouter</a> 是一个轻量级的高性能HTTP请求分发器，英文称之为multiplexer，简称mux。</p>
<h4 id="httproute特性">httproute特性</h4>
<ol>
<li>仅支持精确匹配，及只匹配一个模式或不会匹配到任何模式。相对于其他一些mux，例如go原生的 <a href="http://golang.org/pkg/net/http/#ServeMux">http.ServerMux</a>, 会使得一个请求URL匹配多个模式，从而需要有优先级顺序，例如最长匹配、最先匹配等等。</li>
<li>不需要关心URL结尾的斜杠</li>
<li>路径自动归一化和矫正</li>
<li>零内存分配</li>
<li>高性能。这一点可以参考<a href="https://github.com/julienschmidt/go-http-routing-benchmark">Benchmarks</a></li>
<li>再也不会崩溃</li>
</ol>
<h4 id="示例代码">示例代码</h4>
<p>使用起来非常简单，与 <code>net/http</code> 包提供的接口非常类似，甚至还提供了完全的一致的接口。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;fmt&#34;</span>
    <span style="color:#e6db74">&#34;github.com/julienschmidt/httprouter&#34;</span>
    <span style="color:#e6db74">&#34;net/http&#34;</span>
    <span style="color:#e6db74">&#34;log&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Index</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">httprouter</span>.<span style="color:#a6e22e">Params</span>) {
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprint</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;Welcome!\n&#34;</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Hello</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">ps</span> <span style="color:#a6e22e">httprouter</span>.<span style="color:#a6e22e">Params</span>) {
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;hello, %s!\n&#34;</span>, <span style="color:#a6e22e">ps</span>.<span style="color:#a6e22e">ByName</span>(<span style="color:#e6db74">&#34;name&#34;</span>))
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#a6e22e">router</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">httprouter</span>.<span style="color:#a6e22e">New</span>()
    <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#a6e22e">Index</span>)
    <span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/hello/:name&#34;</span>, <span style="color:#a6e22e">Hello</span>)

    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8080&#34;</span>, <span style="color:#a6e22e">router</span>))
}
</code></pre></div><h4 id="源码阅读">源码阅读</h4>
<p>httproute内部通过实现一个trie树来提高性能。核心代码就是golang标准库中 http.Handler 接口，在该函数中实现自己的请求路由分发策略。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#75715e">// ServeHTTP 实现
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Router</span>) <span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">PanicHandler</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">recv</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">req</span>)
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">root</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">trees</span>[<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Method</span>]; <span style="color:#a6e22e">root</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">path</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Path</span>

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">handle</span>, <span style="color:#a6e22e">ps</span>, <span style="color:#a6e22e">tsr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">root</span>.<span style="color:#a6e22e">getValue</span>(<span style="color:#a6e22e">path</span>); <span style="color:#a6e22e">handle</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">handle</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">ps</span>)
			<span style="color:#66d9ef">return</span>
		} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Method</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;CONNECT&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">path</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;/&#34;</span> {
			<span style="color:#a6e22e">code</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">301</span> <span style="color:#75715e">// Permanent redirect, request with GET method
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Method</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;GET&#34;</span> {
				<span style="color:#75715e">// Temporary redirect, request with same method
</span><span style="color:#75715e"></span>				<span style="color:#75715e">// As of Go 1.3, Go does not support status code 308.
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">code</span> = <span style="color:#ae81ff">307</span>
			}

			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tsr</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">RedirectTrailingSlash</span> {
				<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">path</span>) &gt; <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">path</span>[len(<span style="color:#a6e22e">path</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;/&#39;</span> {
					<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Path</span> = <span style="color:#a6e22e">path</span>[:len(<span style="color:#a6e22e">path</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
				} <span style="color:#66d9ef">else</span> {
					<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Path</span> = <span style="color:#a6e22e">path</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/&#34;</span>
				}
				<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Redirect</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">String</span>(), <span style="color:#a6e22e">code</span>)
				<span style="color:#66d9ef">return</span>
			}

			<span style="color:#75715e">// Try to fix the request path
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">RedirectFixedPath</span> {
				<span style="color:#a6e22e">fixedPath</span>, <span style="color:#a6e22e">found</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">root</span>.<span style="color:#a6e22e">findCaseInsensitivePath</span>(
					<span style="color:#a6e22e">CleanPath</span>(<span style="color:#a6e22e">path</span>),
					<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">RedirectTrailingSlash</span>,
				)
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">found</span> {
					<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Path</span> = string(<span style="color:#a6e22e">fixedPath</span>)
					<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Redirect</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">String</span>(), <span style="color:#a6e22e">code</span>)
					<span style="color:#66d9ef">return</span>
				}
			}
		}
	}

	<span style="color:#75715e">// Handle 405
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">HandleMethodNotAllowed</span> {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">method</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">trees</span> {
			<span style="color:#75715e">// Skip the requested method - we already tried this one
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">method</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Method</span> {
				<span style="color:#66d9ef">continue</span>
			}

			<span style="color:#a6e22e">handle</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">trees</span>[<span style="color:#a6e22e">method</span>].<span style="color:#a6e22e">getValue</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Path</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">handle</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">MethodNotAllowed</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">MethodNotAllowed</span>.<span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">req</span>)
				} <span style="color:#66d9ef">else</span> {
					<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">w</span>,
						<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusText</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusMethodNotAllowed</span>),
						<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusMethodNotAllowed</span>,
					)
				}
				<span style="color:#66d9ef">return</span>
			}
		}
	}

	<span style="color:#75715e">// Handle 404
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">NotFound</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">NotFound</span>.<span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">req</span>)
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NotFound</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">req</span>)
	}
}

</code></pre></div><h3 id="githubcomnbiohttpcontext">github.com/nbio/httpcontext</h3>
<p><a href="github.com/nbio/httpcontext">httpcontext</a>该库提供更灵活的http请求上下文机制。具体实现上，使用了一个小技巧，就是通过动态修改 <code>http.Request.Body</code> 接口来实现的。先看看代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// 核心结构体
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">contextReadCloser</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadCloser</span>
	<span style="color:#a6e22e">context</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">interface</span>{}]<span style="color:#66d9ef">interface</span>{}
}
</code></pre></div><p>上述结构体实现由于直接继承了 ReadCloser 接口，因此可以直接替换掉 <code>http.Request.Body</code> 。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getContextReadCloser</span>(<span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) <span style="color:#a6e22e">ContextReadCloser</span> {
	<span style="color:#a6e22e">crc</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Body</span>.(<span style="color:#a6e22e">ContextReadCloser</span>)
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
		<span style="color:#a6e22e">crc</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">contextReadCloser</span>{
			<span style="color:#a6e22e">ReadCloser</span>: <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Body</span>,
			<span style="color:#a6e22e">context</span>:    make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">interface</span>{}]<span style="color:#66d9ef">interface</span>{}),
		}
		<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Body</span> = <span style="color:#a6e22e">crc</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">crc</span>
}
</code></pre></div><p>我们一起看看下面的示例代码来感受一下这个库的用法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;fmt&#34;</span>
    <span style="color:#e6db74">&#34;github.com/nbio/httpcontext&#34;</span>
    <span style="color:#e6db74">&#34;net/http&#34;</span>
    <span style="color:#e6db74">&#34;log&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Hello</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
    <span style="color:#a6e22e">httpcontext</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#a6e22e">r</span>, <span style="color:#e6db74">&#34;key1&#34;</span>, <span style="color:#e6db74">&#34;value1&#34;</span>) <span style="color:#75715e">// Set a context with this request r
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">val</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">httpcontext</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">r</span>, <span style="color:#e6db74">&#34;key1&#34;</span>)    <span style="color:#75715e">// Get the context
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">val</span>.(<span style="color:#66d9ef">string</span>)
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Got a value associated with key1 : %v\n&#34;</span>, <span style="color:#a6e22e">v</span>)
    <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;OK&#34;</span>))
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/hello&#34;</span>, <span style="color:#a6e22e">Hello</span>)
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8080&#34;</span>, <span style="color:#66d9ef">nil</span>))
}
</code></pre></div>
</div>


    </main>

    
      
    
  </body>
</html>
